<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>SimpleDB WebView - UI and explorer</title>

    <!-- Theme -->
    <link type="text/css" href="themes/aristo/jquery-ui.custom.css" rel="stylesheet" /> 

    <!-- jQuery and jQuery UI -->
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.0/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.12/jquery-ui.min.js"></script>

    <!-- jQuery Templates -->
    <script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>

    <!-- jQuery Layout -->
    <script type="text/javascript" src="plugins/layout/jquery.layout.min-1.2.0.js"></script>

    <!-- jQuery tablefixedheader -->
    <link type="text/css" href="plugins/tablefixedheader/base.css" rel="stylesheet" /> 
    <script type="text/javascript" src="plugins/tablefixedheader/jquery.fixheadertable.js"></script>

    <!-- jQuery cookie -->
    <script type="text/javascript" src="plugins/cookie/jquery.cookie.min.js"></script>

    <!-- Main script -->
    <script type="text/javascript">
      $(function(){       
        $('button').button();
        
        // about
        $('#about-dialog').dialog({
          autoOpen: false,
          width: 400,
          title: 'About',
          modal: true,
          buttons: {
            Ok: function() {
              $(this).dialog('close');
            }
          }         
        });
        
        // Layout
        $('body').layout({ 
          applyDefaultStyles: true,
          spacing_open: 4,
          north__spacing_open: 0,
          north__size: 50,
          north__resizable: false,
          north__closable: false,
          west__minSize: 150
        });
                
        // Cookie management
        function getCredentialsInput(){
          return {keyid:$('input#keyid').val(), secret:$('input#secret').val()};
        }
        if ($.cookie('aws-credentials')) {
          var creds = JSON.parse($.cookie('aws-credentials'));
          $('input#keyid').val(creds.keyid);
          $('input#secret').val(creds.secret);
        }
        
        // getDomains()
        function getDomains(callback) {          
          $('.ui-layout-west .loading-icon').show();
          $.get('/get.domains', getCredentialsInput(), function(data){
            $(data).each(function(index, domain){
              var $obj = $('<div class="domain"> <div class="db-icon"><img src="img/db.png"></img></div> <div class="domain-name-wrapper"><span class="domain-name"></span> <span class="count"></span></div> </div>');
              $obj.find(".domain-name").html(domain.name);
              $obj.appendTo('.ui-layout-west .contents');
              $obj.find('.count').html('('+domain.count+')');
            });
          }, 'json')
          .error(function(){
            alert('Error getting data from server');
          })
          .complete(function(){
            $('.ui-layout-west .loading-icon').hide();            
          });
        }
        
        // encodeHtml()
        function encodeHtml(str){
          return $('<div/>').text(str).html();
        }
              
        // displayTable()
        function displayTable($theTable){
          var numFields = $theTable.find('thead th').size();
          var colRatioVector = [];
          for (var i=0;i<numFields;i++){
            colRatioVector.push(200);
          }
          var $origTableParent = $theTable.parent(); // prior to the wrappers due to fixheadertable()
          $theTable.fixheadertable({
            zebra: true,
            zebraClass: 'table-zebra',
            height: 200,          
            wrapper: false,
            colratio: colRatioVector,
            resizeCol: true
          });
        
          fitTable($theTable, $origTableParent);
          $(window).resize(function(){
            clearTimeout(window.resizeTimer);
            window.resizeTimer = setTimeout(function(){ // hack to ensure the event is only fired *after* resizing motion            
              fitTable($theTable, $origTableParent);                        
            }, 500);
          });
          
          function fitTable($tableObj, $parentObj) {
            var $tableBody = $tableObj.parents('.body');
            $tableBody.height( $parentObj.height() - $tableBody.siblings('.headtable').height() - 2); // see DOM after $.fixheadertable()
          }
        }

        // displayData()
        function displayData(data){          
          // build fieldNames from heterogeneous data
          var fieldNames = [];
          data.forEach(function(datum){ // loop over each row
            for (key in datum) {
              if (fieldNames.indexOf(key)<0)
                fieldNames.push(key);
            }
          });
          fieldNames.sort();

          // build table head
          var $table = $('<table cellpadding="0" cellspacing="0" border="0" class="display" id="the-table"></table>');
          var $tHead = $('<thead></thead>').appendTo($table);
          var templateStr = '';
          fieldNames.forEach(function(field){
            $('<th></th>').html(field).appendTo($tHead);
            templateStr += '<td>${'+encodeHtml(field)+'}</td>';
          });

          // build table body
          var $tBody = $('<tbody></tbody>').appendTo($table);
          templateStr = '<tr>'+templateStr+'</tr>';
          $.template('dataTemplate', templateStr);
          $.tmpl('dataTemplate', data).appendTo($tBody);
          
          $table.appendTo('.ui-layout-center .contents');
          displayTable($table);
        }

        // getItems()
        function getItems($obj){
          $('.ui-layout-center .contents').html('');
          $('.ui-layout-center .loading-icon').show();
          var domainName = $obj.find('.domain-name').html();
          var theData = getCredentialsInput();
          theData.domain = domainName;
          $.get('/get.items', theData, function(data){
            $('.ui-layout-center .loading-icon').hide();
            displayData(data);
          }, 'json');
        }

        // click: view domains button
        $('button#view').click(function(){          
          $.cookie('aws-credentials', JSON.stringify(getCredentialsInput()), {path:"/", expires:30}); // expires in 1 month
          $('.ui-layout-west .contents').html('');
          getDomains();
        });
        
        // click: domain pane
        $('.domain').live('click', function(e){
          $('.domain.selected').removeClass('selected');
          $(this).addClass('selected');          
          
          getItems($(this));
        });
        
        // click: about button
        $('button#about').click(function(){
          $('#about-dialog').dialog('open');
        });
      });
    </script>

    <style type="text/css">
      html,body { margin:0; padding:0; font-family: Arial, sans-serif; font-size:13px; cursor:default; }
      input { padding:6px !important; font-size:13px; }
      button { height:31px; }
        
      .ui-layout-north { padding:0 !important; overflow:hidden !important; }
      .ui-layout-center { padding:0 !important; overflow:hidden !important; font-size:11px !important; }
      .ui-layout-west { padding:5px 0 !important; overflow:hidden !important; background:#D2D8E1 !important; }

      /* WEST */
      .ui-layout-west .title { color:#777; padding:5px 0 5px 8px; }
      .ui-layout-west .contents .domain { position:relative; cursor:pointer; padding:3px 5px 3px 10px; color:#141314; text-shadow:#e0e0e0 1px 1px 0; }
      .ui-layout-west .contents .domain.selected {
        color:#FFFFF5; text-shadow:#555 0 1px 0;
        background: #A0B0CF !important; /* for non-css3 browsers */

        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#A0B0CF', endColorstr='#7186AB') !important; /* for IE */
        background: -webkit-gradient(linear, left top, left bottom, from(#A0B0CF), to(#7186AB)) !important; /* for webkit browsers */
        background: -moz-linear-gradient(top,  #A0B0CF,  #7186AB) !important; /* for firefox 3.6+ */ 
      }
      .ui-layout-west .contents .db-icon { position:absolute; top:3px; left:6px; }
      .ui-layout-west .contents .domain-name-wrapper { margin-left:20px; margin-right:30px; }
      .ui-layout-west .loading-icon { display:none; position:absolute; top:50px; left:0; right:0; text-align:center; }

      /* NORTH */
      .ui-layout-north {
        background: #777 !important; /* for non-css3 browsers */

        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#cccccc', endColorstr='#777777') !important; /* for IE */
        background: -webkit-gradient(linear, left top, left bottom, from(#ccc), to(#777)) !important; /* for webkit browsers */
        background: -moz-linear-gradient(top,  #ccc,  #777) !important; /* for firefox 3.6+ */ 
      }
      .ui-layout-north img { position:absolute; top:0; left:0; }
      .ui-layout-north .credentials { position:absolute; top:7px; left:380px; }
      .ui-layout-north .right { position:absolute; top:7px; right:20px; }

      /* CENTER */
      .ui-layout-center .contents { position:absolute; top:0; left:0; right:0; bottom:0; }
      .ui-layout-center .contents table th { color:#000 !important; }
      .ui-layout-center .contents table td { color:#333 !important; }
      .ui-layout-center .loading-icon { display:none; position:absolute; top:100px; left:0; right:0; text-align:center; }
      
      /* Table */
      .table-zebra { background:#F0F4F9; }
      div.t_fixed_header.ui .body tr td { border:none }
    </style>  
  </head>

  <body>

    <div class="ui-layout-north">
      <img src='img/logo.png' />
      <div class='credentials'>
        <input id='keyid' style='width:150px' placeholder='AWS Access Key ID'></input>
        <input id='secret' style='width:150px' placeholder='AWS Secret Access Key'></input>
        &nbsp;
        <button id='view'>View contents</button>
      </div>
      <div class='right'>
        <button id='about'>About</button>
      </div>
    </div>
        
    <div class="ui-layout-west">
      <div class='title'>Domains</div>
      <div class='loading-icon'><img src='img/ajax.gif'/></div>
      <div class='contents'></div>
    </div>

    <div class="ui-layout-center">
      <div class='loading-icon'><img src='img/ajax.gif'/></div>
      <div class='contents'></div>
    </div>

    <div id='about-dialog' style='display:none;'>
      <p>
        <div>SimpleDB WebView</div>
        <div>Copyright (c) 2011 Artur B. Adib</div>
        <div>Licensed under the <a href='http://www.opensource.org/licenses/mit-license.php' target='_blank'>MIT Open Source license</a></div>      
      </p>
    </div>

  </body>
</html>
